(function(a){a.fn.smartupdater=function(b,c){return this.each(function(){var d=this,e={};d.settings=a.extend(true,{url:"",type:"get",data:"",dataType:"text",minTimeout:60000,maxFailedRequests:10,maxFailedRequestsCb:false,httpCache:false,rCallback:false,selfStart:true,smartStop:{active:false,monitorTimeout:2500,minHeight:1,minWidth:1}},b);d.smartupdaterStatus={state:"",timeout:0};e=d.settings;e.prevContent="";e.failedRequests=0;e.etag="0";e.lastModified="0";e.callback=c;e.origReq={url:e.url,data:e.data,callback:c};e.stopFlag=false;function f(){if(!a(d).parents("body").length){clearInterval(d.smartupdaterStatus.smartStop);clearTimeout(d.settings.h);d={};return}a.ajax({url:e.url,type:e.type,data:e.data,dataType:e.dataType,cache:false,success:function(l,m,n){var j=false,h=false,k=a.parseJSON(n.getResponseHeader("X-Smartupdater")),g,i;if(k){e.minTimeout=k.timeout?k.timeout:e.minTimeout;h=k.callback?k.callback:false}if(e.httpCache){g=n.getResponseHeader("ETag");i=n.getResponseHeader("Last-Modified");j=(e.etag==g||e.lastModified==i)?true:false;e.etag=g?g:e.etag;e.lastModified=i?i:e.lastModified}if(j||e.prevContent==n.responseText||n.status==304){if(!e.stopFlag){clearTimeout(e.h);e.h=setTimeout(f,e.minTimeout)}}else{e.prevContent=n.responseText;if(!e.stopFlag){clearTimeout(e.h);e.h=setTimeout(f,e.minTimeout)}if(e.rCallback&&h&&e.rCallback.search(h)!=-1){window[h](l)}else{e.callback(l)}}d.smartupdaterStatus.timeout=e.minTimeout;e.failedRequests=0},error:function(h,i,g){if(++e.failedRequests<e.maxFailedRequests){if(!e.stopFlag){clearTimeout(e.h);e.h=setTimeout(f,e.minTimeout);d.smartupdaterStatus.timeout=e.minTimeout}}else{clearTimeout(e.h);d.smartupdaterStatus.state="OFF";if(typeof(e.maxFailedRequestsCb)==="function"){e.maxFailedRequestsCb(h,i,g)}}},beforeSend:function(h,g){if(e.httpCache){h.setRequestHeader("If-None-Match",e.etag);h.setRequestHeader("If-Modified-Since",e.lastModified)}h.setRequestHeader("X-Smartupdater",'{"timeout":"'+d.smartupdaterStatus.timeout+'"}')}});d.smartupdaterStatus.state="ON"}e.fnStart=f;if(e.selfStart){f()}if(e.smartStop.active){d.smartupdaterStatus.smartStop=setInterval(function(){if(!a(d).parents("body").length){clearInterval(d.smartupdaterStatus.smartStop);clearTimeout(d.settings.h);d={};return}var h=a(d);var i=h.width(),g=h.height(),j=h.is(":hidden");if(!j&&g>e.smartStop.minHeight&&i>e.smartStop.minWidth&&d.smartupdaterStatus.state=="OFF"){h.smartupdaterRestart()}else{if((j||g<=e.smartStop.minHeight||i<=e.smartStop.minWidth)&&d.smartupdaterStatus.state=="ON"){h.smartupdaterStop()}}},e.smartStop.monitorTimeout)}})};a.fn.smartupdaterStop=function(){return this.each(function(){this.settings.stopFlag=true;clearTimeout(this.settings.h);this.smartupdaterStatus.state="OFF"})};a.fn.smartupdaterRestart=function(){return this.each(function(){this.settings.stopFlag=false;clearTimeout(this.settings.h);this.settings.failedRequests=0;this.settings.etag="0";this.settings.lastModified="0";this.settings.fnStart()})};a.fn.smartupdaterSetTimeout=function(b){return this.each(function(){clearTimeout(this.settings.h);this.settings.minTimeout=b;this.settings.fnStart()})};a.fn.smartupdaterAlterCallback=function(b){return this.each(function(){this.settings.callback=b?b:this.settings.origReq.callback})};a.fn.smartupdaterAlterUrl=function(b,c){return this.each(function(){this.settings.url=b?b:this.settings.origReq.url;this.settings.data=c?c:this.settings.origReq.data})}})(jQuery);